<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ver pel√≠cula</title>
<link rel="stylesheet" href="https://zonaaps-player.xyz/style.css">
<script src="https://cdn.jwplayer.com/libraries/IDzF9Zmk.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif}
body{
  background-color:#000;
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  min-height:100vh;
  color:#fff;
  overflow-x:hidden;
}
.overlay{
  backdrop-filter:blur(1px);
  background:rgba(0,0,0,0.85);
  min-height:100vh;
  width:100%;
  padding:40px 20px;
  display:flex;
  justify-content:center;
  align-items:flex-start;
}
.container{
  display:flex;
  align-items:flex-start;
  justify-content:center;
  flex-wrap:wrap;
  gap:40px;
  max-width:1200px;
  width:100%;
}
.poster{
  width:200px;
  border-radius:15px;
  box-shadow:0 8px 25px rgba(0,0,0,0.7);
  flex-shrink:0;
}
.info{
  flex:1;
  min-width:280px;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
}
.info-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  gap:15px;
}
h1{
  font-size:2rem;
  font-weight:600;
  color:#fff;
  flex:1;
}
.details{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:15px;
  color:#ccc;
  font-size:0.95rem;
  margin-top:10px;
}
.rating-circle{
  position:relative;
  width:55px;
  height:55px;
  border-radius:50%;
  background:#081c14;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  color:#00ff99;
  font-size:0.9rem;
  flex-shrink:0;
}
.rating-circle svg{
  position:absolute;
  top:0;left:0;
  transform:rotate(-80deg);
}
.stars{
  color:#00aaff;
  font-size:1rem;
}
.tags{
  margin-top:10px;
  color:#aaa;
  font-size:0.9rem;
}
.overview-box{
  background: rgba(0, 0, 0, 0.08);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:10px;
  padding:15px;
  color:#ccc;
  font-size:0.9rem;
  line-height:1.6;
  margin-top:15px;
  box-shadow:0 4px 15px rgba(0,0,0,0.4);
  max-height:160px;
  overflow-y:auto;
  scrollbar-width:thin;
  scrollbar-color:#00ff99 #111;
}
.overview-box::-webkit-scrollbar{width:6px;}
.overview-box::-webkit-scrollbar-thumb{background:#00ff99;border-radius:4px;}
.overview-box::-webkit-scrollbar-track{background:#111;}
.buttons{
  display:flex;
  gap:12px;
  margin:20px 0;
  flex-wrap:wrap;
}
.btn{
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
  padding:10px 18px;
  font-size:1rem;
}
.btn-blue{background:#007bff;color:#fff;}
.btn-yellow{background:#ffc107;color:#000;}
.btn:hover{opacity:0.9}
#player-container{
  position:relative;
  width:100%;
  aspect-ratio:16/9;
  margin-top:20px;
  border-radius:12px;
  overflow:hidden;
  box-shadow:0 8px 30px rgba(0,0,0,0.7);
  background:#000;
}
#player{width:100%;height:100%}
.loading{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  color:#00ff99;
  font-weight:bold;
  font-size:1.1rem;
}
.resume-overlay{
  position:absolute;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.75);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:999;
}
.resume-overlay button{
  background:#00ff99;color:#000;font-weight:bold;border:none;
  padding:10px 18px;border-radius:8px;margin:8px;cursor:pointer;
}
.resume-overlay button:hover{background:#00cc7a}

/* Icono cast personalizado en esquina (por si JW no carga controles personalizados) */
.custom-cast-btn{
  position:absolute;
  right:12px;
  top:12px;
  z-index:1001;
  background:rgba(0,0,0,0.5);
  border-radius:8px;
  padding:8px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
}
.custom-cast-btn svg{width:22px;height:22px;display:block;}

/* üîπ Responsivo */
@media (max-width:900px){
  .container{flex-direction:column;align-items:center;text-align:center;}
  .poster{width:60%;max-width:200px;}
  .info-header{flex-direction:column;align-items:center;justify-content:center;}
  .info{text-align:center;align-items:center;}
  .details{justify-content:center;}
  .buttons{justify-content:center;}
  .overview-box{max-height:200px;}
}
@media (min-width:1600px){
  .poster{width:320px;}
  .info h1{font-size:2.3rem;}
  .overview-box{font-size:1.1rem;max-height:220px;}
}
</style>
</head>

<body>
<div class="overlay">
  <div class="container" id="movieContainer">
    <p class="loading">Cargando pel√≠cula...</p>
  </div>
</div>

<script>
/* ----- Config ----- */
const TMDB_KEY="cc5b94165972aa509a349161d13d4fc9";
const TMDB_BASE="https://api.themoviedb.org/3";
const TMDB_IMG="https://image.tmdb.org/t/p/original";
const VIDEO_FOLDER="peliculas";
const FORMATS=[".mkv",".mp4",".m3u8",".avi",".mov",".webm",".flv"];
const JSON_PATH="data/enlaces.json";
const id=new URLSearchParams(window.location.search).get("id");

/* ----- Util ----- */
function formatDate(d){ if(!d) return "Desconocida"; const p=d.split("-"); return p[0]; }
async function fileExists(url){
  try{
    const r=await fetch(url,{method:"HEAD"});
    return r.ok;
  }catch{return false;}
}
function el(html){ const div=document.createElement('div'); div.innerHTML=html; return div.firstElementChild; }

/* ----- Inicio ----- */
if(!id){
  document.getElementById("movieContainer").innerHTML=`<div class="not-found">No se proporcion√≥ ID.</div>`;
}else{
  init();
}

async function init(){
  try{
    const res=await fetch(`${TMDB_BASE}/movie/${id}?api_key=${TMDB_KEY}&language=es-MX&append_to_response=credits`);
    const movie=await res.json();
    renderMovie(movie);
  }catch(e){
    document.getElementById("movieContainer").innerHTML=`<div class="not-found">Error al cargar la pel√≠cula.</div>`;
  }
}

function renderMovie(movie){
  if(movie.backdrop_path){
    document.body.style.backgroundImage=`url(${TMDB_IMG + movie.backdrop_path})`;
  }

  const container=document.getElementById("movieContainer");
  const rating=Math.round(movie.vote_average*10);
  const starsCount=Math.round(movie.vote_average/2);
  const stars="‚òÖ".repeat(starsCount)+"‚òÜ".repeat(5-starsCount);
  const genres=(movie.genres||[]).map(g=>g.name).join(", ");
  const country=(movie.production_countries?.[0]?.name)||"Desconocido";
  const director=(movie.credits?.crew?.find(p=>p.job==="Director")?.name)||"Desconocido";
  const cast=(movie.credits?.cast||[]).slice(0,5).map(a=>a.name).join(", ");

  container.innerHTML=`
    <img src="${TMDB_IMG + movie.poster_path}" class="poster">
    <div class="info">
      <div class="info-header">
        <h1>${movie.title}</h1>
        <div class="rating-circle">
          <svg width="55" height="55">
            <circle cx="27.5" cy="27.5" r="22" stroke="#004d00" stroke-width="5" fill="none"/>
            <circle cx="27.5" cy="27.5" r="22" stroke="#00ff99" stroke-width="5" fill="none"
              stroke-dasharray="138" stroke-dashoffset="${138 - (138*rating/100)}"/>
          </svg>${rating}%
        </div>
      </div>
      <div class="stars">${stars}</div>
      <div class="details">
        <span>üìÖ ${formatDate(movie.release_date)}</span>
        <span>‚è±Ô∏è ${movie.runtime || "?"} min</span>
        <span>üåé ${country}</span>
      </div>
      <div class="tags">üéûÔ∏è ${genres}</div>

      <div class="overview-box">
        ${movie.overview || "Sin descripci√≥n disponible."}
      </div>

      <p style="color:#00aaff;margin-top:10px;"><b>Director:</b> ${director}</p>
      <p style="color:#aaa;"><b>Reparto:</b> ${cast}</p>

      <div id="player-container">
        <div id="player"></div>
        <div class="loading" id="loading">Cargando video...</div>
        <!-- Bot√≥n cast alternativo (en caso de que JW no permita a√±adir bot√≥n); oculto si JW a√±adi√≥ su bot√≥n -->
        <div class="custom-cast-btn" id="customCastBtn" title="Enviar a Web Video Caster" style="display:none;">
          <!-- SVG de icono cast -->
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 18h2a1 1 0 0 1 1 1v2H1v-3zM1 14h2a5 5 0 0 1 5 5v3h2v-3a7 7 0 0 0-7-7H1v2z" fill="#fff"/>
            <path d="M21 3H3v4h2V5h14v14h-4v2h6V3z" fill="#fff" opacity="0.9"/>
          </svg>
        </div>
      </div>
    </div>
  `;
  loadVideo(id,movie);
}

/* ----- Carga del video (b√∫squeda en JSON o carpeta, fallback) ----- */
async function loadVideo(id,movie){
  let found=null;
  try{
    const res=await fetch(JSON_PATH);
    const data=await res.json();
    if(data && data[id]) found = data[id];
  }catch(e){
    console.warn("No se pudo cargar enlaces.json",e);
  }

  if(!found){
    for(const ext of FORMATS){
      const url = `${window.location.origin}/${VIDEO_FOLDER}/${id}${ext}`;
      if(await fileExists(url)){ found = url; break; }
    }
  }

  const playerDiv=document.getElementById("player");
  const loadingDiv=document.getElementById("loading");
  const containerDiv=document.getElementById("player-container");
  const customCastBtn=document.getElementById('customCastBtn');

  if(!found){
    loadingDiv.style.display="none";
    playerDiv.innerHTML=`<div class="not-found">üé¨ No disponible.</div>`;
    return;
  }

  // almacenar el enlace en una variable JS (no se agrega href visible)
  const videoSource = found;

  // detectar extensi√≥n
  const ext = (found.split('.').pop() || "").toLowerCase();
  let jwType = "mp4";
  if(ext === "m3u8") jwType = "hls";
  if(ext === "mkv") jwType = "mkv"; // intento con jwplayer, si falla cae a HTML5

  // Funci√≥n que abre Web Video Caster (esquema). NO hay <a href> visible en DOM.
  function openWVC(url){
    try{
      const scheme = `wvc-x-callback://open?url=${encodeURIComponent(url)}&secure_uri=true`;
      // Intento abrir esquema (en Android abrir√° app si instalada)
      window.location.href = scheme;
      // como respaldo, intentar window.open
      setTimeout(()=>{ window.open(scheme); }, 200);
    }catch(e){
      console.error("Error abriendo Web Video Caster", e);
    }
  }

  /* ----- Setup JW Player (principal) ----- */
  let player;
  try{
    player = jwplayer("player").setup({
      file: videoSource,
      type: (jwType === "hls") ? "hls" : undefined,
      width: "100%",
      height: "100%",
      autostart: false,
      controls: true,
      mute:false,
      playbackRateControls: true,
      skin: { name: "netflix" },
      stretching: "uniform",
      image: movie.backdrop_path ? TMDB_IMG + movie.backdrop_path : ""
      
    });

    // A√±adir bot√≥n personalizado para Cast en la barra de JW (imagen como data URL SVG)
    const svgIcon = encodeURIComponent(
      `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'>
         <path d='M1 18h2a1 1 0 0 1 1 1v2H1v-3zM1 14h2a5 5 0 0 1 5 5v3h2v-3a7 7 0 0 0-7-7H1v2z' fill='#fff'/>
         <path d='M21 3H3v4h2V5h14v14h-4v2h6V3z' fill='#fff' opacity='0.9'/>
       </svg>`
    );
    const svgDataUrl = `data:image/svg+xml;charset=utf8,${svgIcon}`;

    player.on('ready', () => {
      if(loadingDiv) loadingDiv.style.display="none";

      // A√±adir el bot√≥n cast a JW controls (solo si api lo permite)
      try{
        if(typeof player.addButton === 'function'){
          player.addButton(svgDataUrl, 'Enviar a Web Video Caster', () => {
            openWVC(videoSource);
          }, 'wvc-cast-button');
          // ocultar el bot√≥n manual alternativo
          if(customCastBtn) customCastBtn.style.display = 'none';
        }else{
          // si no existe addButton, mostramos el bot√≥n custom que colocamos en DOM
          if(customCastBtn) customCastBtn.style.display = 'flex';
        }
      }catch(e){
        if(customCastBtn) customCastBtn.style.display = 'flex';
      }

      // Resume overlay si hay tiempo guardado
      const savedTime = localStorage.getItem(`movie_${id}_time`);
      if(savedTime && parseFloat(savedTime) > 30){
        const overlay = document.createElement('div');
        overlay.className = 'resume-overlay';
        overlay.innerHTML = `<p>¬øContinuar desde ${(savedTime/60).toFixed(1)} min?</p>
          <div><button id="resumeYes">S√≠</button><button id="resumeNo">No</button></div>`;
        document.getElementById('player-container').appendChild(overlay);
        document.getElementById('resumeYes').onclick = () => { overlay.remove(); player.seek(parseFloat(savedTime)); player.play(true); };
        document.getElementById('resumeNo').onclick = () => { overlay.remove(); player.play(true); };
      }

      // Guardado peri√≥dico del progreso (cada 10s)
      setInterval(()=>{
        try{
          const pos = player.getPosition();
          if(pos > 0) localStorage.setItem(`movie_${id}_time`, pos);
        }catch(e){}
      },10000);
    });

    // Si JW devuelve error (p. ej. formato no soportado), destruimos y usamos HTML5 fallback
    player.on('error', (err) => {
      console.warn("JW Player error:", err);
      // peque√±a demora para que JW termine
      setTimeout(()=>{ try{ player.remove(); }catch(e){}; createHtml5Fallback(videoSource); }, 200);
    });

    // Detecci√≥n adicional: si JW est√° listo pero no reproduce (por ejemplo mkv no soportado),
    // verificamos si el navegador lanza error de media - fallback si no reproduce despu√©s de 3s de intento de play
    let attemptedPlay = false;
    player.on('play', ()=>{ attemptedPlay = true; });
    setTimeout(()=>{
      if(!attemptedPlay && ext === 'mkv'){
        // probable que no pueda reproducir mkv en JW/browsers -> fallback
        try{ player.remove(); }catch(e){}; createHtml5Fallback(videoSource);
      }
    },3000);

  }catch(e){
    console.warn("Error inicializando JW Player, uso fallback HTML5", e);
    createHtml5Fallback(videoSource);
  }

  /* ----- Bot√≥n cast alternativo (DOM) ----- */
  if(customCastBtn){
    customCastBtn.onclick = ()=>{ openWVC(videoSource); };
  }

  /* ----- HTML5 fallback (si JW falla o formato no soportado) ----- */
  function createHtml5Fallback(src){
    // limpiar contenedor
    const playerContainer = document.getElementById('player');
    if(!playerContainer) return;
    playerContainer.innerHTML = '';
    if(loadingDiv) loadingDiv.style.display = 'none';

    // Crear video HTML5
    const video = document.createElement('video');
    video.id = 'html5player';
    video.controls = true;
    video.playsInline = true;
    video.style.width = '100%';
    video.style.height = '100%';
    video.setAttribute('webkit-playsinline', 'true');
    video.setAttribute('preload','metadata');

    // Source
    const source = document.createElement('source');
    source.src = src;
    // intentar adivinar tipo MIME para .mkv
    const mimeMap = {
      'mp4':'video/mp4',
      'mkv':'video/x-matroska',
      'webm':'video/webm',
      'mov':'video/quicktime',
      'avi':'video/x-msvideo',
      'm3u8':'application/vnd.apple.mpegurl'
    };
    const ext2 = (src.split('.').pop() || '').toLowerCase();
    source.type = mimeMap[ext2] || 'video/mp4';
    video.appendChild(source);

    playerContainer.appendChild(video);

    // Mostrar bot√≥n cast alternativo (si el bot√≥n JW no existe)
    if(customCastBtn) customCastBtn.style.display = 'flex';

    // resume overlay para HTML5
    const savedTime = localStorage.getItem(`movie_${id}_time`);
    if(savedTime && parseFloat(savedTime) > 30){
      const overlay = document.createElement('div');
      overlay.className = 'resume-overlay';
      overlay.innerHTML = `<p>¬øContinuar desde ${(savedTime/60).toFixed(1)} min?</p>
        <div><button id="resumeYes2">S√≠</button><button id="resumeNo2">No</button></div>`;
      document.getElementById('player-container').appendChild(overlay);
      document.getElementById('resumeYes2').onclick = ()=>{ overlay.remove(); video.currentTime = parseFloat(savedTime); video.play(); };
      document.getElementById('resumeNo2').onclick = ()=>{ overlay.remove(); video.play(); };
    }

    // Guardado peri√≥dico del progreso (HTML5)
    setInterval(()=>{
      try{
        const pos = video.currentTime;
        if(pos > 0) localStorage.setItem(`movie_${id}_time`, pos);
      }catch(e){}
    },10000);

    // Si navegador no admite mkv y video falla, mostramos mensaje
    video.onerror = function(){
      console.warn('HTML5 video error:', video.error);
      const msg = document.createElement('div');
      msg.className = 'not-found';
      msg.style.padding = '20px';
      msg.innerHTML = `<p>No se pudo reproducir el archivo en tu navegador. Si es .mkv puede que el navegador no lo soporte. Puedes intentar abrirlo con Web Video Caster desde el bot√≥n de enviar.</p>`;
      playerContainer.innerHTML = '';
      playerContainer.appendChild(msg);
      if(customCastBtn) customCastBtn.style.display = 'flex';
    };
  }
}
</script>
</body>
</html>
