<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ver pel√≠cula</title>

<script src="https://cdn.jwplayer.com/libraries/IDzF9Zmk.js"></script>

<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif}
  body{
    background-color:#000;
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    min-height:100vh;
    color:#fff;
    overflow-x:hidden;
    transition: background 0.5s ease-in-out;
  }
  .overlay{
    background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.95));
    min-height:100vh;
    width:100%;
    padding:20px;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    flex-direction:column;
  }
  .container{
    max-width:900px;
    margin:auto;
    text-align:center;
  }
  .poster{
    width:180px;
    border-radius:16px;
    box-shadow:0 8px 25px rgba(0,0,0,0.6);
    margin-top:20px;
  }
  h1{
    font-size:1.2rem;
    margin-top:14px;
    font-weight:600;
  }
  .details{
    display:flex;
    justify-content:center;
    gap:14px;
    margin-top:8px;
    font-size:0.9rem;
    color:#ccc;
    align-items:center;
  }
  .rating-circle{
    position:relative;
    width:50px;
    height:50px;
    border-radius:50%;
    background:#081c14;
    display:flex;
    justify-content:center;
    align-items:center;
    font-weight:bold;
    color:#00ff99;
    font-size:0.85rem;
  }
  .rating-circle svg {
    position:absolute;
    top:0;
    left:0;
    transform:rotate(-90deg);
  }
  .genres{
    display:flex;
    justify-content:center;
    flex-wrap:wrap;
    gap:10px;
    margin-top:14px;
  }
  .genre{
    background:#0d1b2a;
    color:#fff;
    padding:6px 14px;
    border-radius:20px;
    font-size:0.85rem;
  }
  .overview{
    color:#ccc;
    margin-top:14px;
    font-size:0.95rem;
    line-height:1.5;
  }
  #player-container{
    position:relative;
    width:100%;
    aspect-ratio:16/9;
    margin-top:26px;
    border-radius:12px;
    overflow:hidden;
    box-shadow:0 8px 30px rgba(0,0,0,0.7);
    background:#000;
  }
  #player{
    width:100%;
    height:100%;
  }
  .loading{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    color:#00ff99;
    font-weight:bold;
    font-size:1.1rem;
  }
  .not-found{
    padding:30px;
    text-align:center;
    color:#bbb;
  }
</style>
</head>
<body>
<div class="overlay">
  <div class="container" id="movieContainer">
    <p class="loading">Cargando pel√≠cula...</p>
  </div>
</div>

<script>
const TMDB_KEY = "cc5b94165972aa509a349161d13d4fc9";
const TMDB_BASE = "https://api.themoviedb.org/3";
const TMDB_IMG = "https://image.tmdb.org/t/p/original";
const VIDEO_FOLDER = "peliculas"; 
const FORMATS = [".mkv", ".mp4", ".m3u8"];
const JSON_PATH = "data/enlaces.json"; 

const id = new URLSearchParams(window.location.search).get("id");

if(!id){
  document.getElementById("movieContainer").innerHTML=`<div class="not-found">No se proporcion√≥ ID de pel√≠cula.</div>`;
}else{
  init();
}

async function init(){
  try{
    const res = await fetch(`${TMDB_BASE}/movie/${id}?api_key=${TMDB_KEY}&language=es-MX`);
    const movie = await res.json();
    renderMovie(movie);
  }catch(e){
    document.getElementById("movieContainer").innerHTML=`<div class="not-found">No se pudo cargar la informaci√≥n de la pel√≠cula.</div>`;
  }
}

function formatDate(d){if(!d) return "Desconocida"; const parts=d.split("-"); return `${parts[2]}/${parts[1]}/${parts[0]}`;}

function renderMovie(movie){
  if(movie.backdrop_path){
    document.body.style.backgroundImage=`url(${TMDB_IMG + movie.backdrop_path})`;
  }

  const container=document.getElementById("movieContainer");
  const rating=Math.round(movie.vote_average*10);
  container.innerHTML=`
    <img src="${TMDB_IMG + movie.poster_path}" class="poster">
    <h1>${movie.title}</h1>
    <div class="details">
      <span>üìÖ ${formatDate(movie.release_date)}</span>
      <span>‚è±Ô∏è ${movie.runtime || "?"} min</span>
      <div class="rating-circle">
        <svg width="50" height="50">
          <circle cx="25" cy="25" r="20" stroke="#004d00" stroke-width="5" fill="none"/>
          <circle cx="25" cy="25" r="20" stroke="#00ff99" stroke-width="5" fill="none" stroke-dasharray="125.6" stroke-dashoffset="${125.6 - (125.6*rating/100)}" style="transition: stroke-dashoffset 1s ease"/>
        </svg>
        ${rating}%
      </div>
    </div>
    <div class="genres">${(movie.genres || []).map(g=>`<div class="genre">${g.name}</div>`).join("")}</div>
    <div class="overview">${movie.overview || "Sin descripci√≥n disponible."}</div>
    <div id="player-container">
      <div id="player"></div>
      <div class="loading" id="loading">Cargando video...</div>
    </div>
  `;
  loadVideo(id);
}

async function fileExists(url){
  try{
    const r=await fetch(url,{method:"HEAD"});
    return r.ok;
  }catch{return false;}
}

async function loadVideo(id){
  let found=null;

  try{
    const res=await fetch(JSON_PATH);
    const data=await res.json();
    if(data[id]) found=data[id];
  }catch(e){console.warn("No se pudo cargar enlaces.json", e);}

  if(!found){
    for(const ext of FORMATS){
      const url=`${window.location.origin}/${VIDEO_FOLDER}/${id}${ext}`;
      if(await fileExists(url)){
        found=url;
        break;
      }
    }
  }

  const playerDiv=document.getElementById("player");
  const loadingDiv=document.getElementById("loading");
  if(!found){
    loadingDiv.style.display="none";
    playerDiv.innerHTML=`<div class="not-found">üé¨ Esta pel√≠cula a√∫n no est√° disponible.<br>
      Agrega un enlace en <code>${JSON_PATH}</code> o sube el archivo a <code>/${VIDEO_FOLDER}/${id}.mp4</code>.</div>`;
    return;
  }

  console.log("üé• Enlace de video encontrado:",found);

  jwplayer("player").setup({
    file:found,
    type:"mp4",
    width:"100%",
    height:"100%",
    autostart:false,
    controls:true,
    playbackRateControls:true,
    skin:{name:"seven"},
    stretching:"uniform",
    image:TMDB_IMG+movie.backdrop_path
  });

  jwplayer("player").on('ready', function(){if(loadingDiv) loadingDiv.style.display="none";});
}
</script>
</body>
</html>
