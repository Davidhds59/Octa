<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ver pel√≠cula</title>

  <script src="https://cdn.jwplayer.com/libraries/IDzF9Zmk.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif}
    body{
      background-color:#000;
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      min-height:100vh;
      color:#fff;
      overflow-x:hidden;
    }
    .overlay{
      background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.95));
      min-height:100vh;
      width:100%;
      padding:20px;
    }
    .container{
      max-width:900px;
      margin:auto;
      text-align:center;
    }
    .poster{
      width:180px;
      border-radius:16px;
      box-shadow:0 8px 25px rgba(0,0,0,0.6);
      margin-top:20px;
    }
    h1{
      font-size:1.2rem;
      margin-top:14px;
      font-weight:600;
    }
    .details{
      display:flex;
      justify-content:center;
      gap:14px;
      margin-top:8px;
      font-size:0.9rem;
      color:#ccc;
    }
    .rating{
      display:flex;
      align-items:center;
      gap:4px;
      color:#00ff99;
      font-weight:500;
    }
    .genres{
      display:flex;
      justify-content:center;
      flex-wrap:wrap;
      gap:10px;
      margin-top:14px;
    }
    .genre{
      background:#0d1b2a;
      color:#fff;
      padding:6px 14px;
      border-radius:20px;
      font-size:0.85rem;
    }
    .overview{
      color:#ccc;
      margin-top:14px;
      font-size:0.95rem;
      line-height:1.5;
    }
    #player{
      width:100%;
      aspect-ratio:16/9;
      margin-top:26px;
      border-radius:12px;
      overflow:hidden;
      box-shadow:0 8px 30px rgba(0,0,0,0.7);
    }
    .not-found{
      padding:30px;
      text-align:center;
      color:#bbb;
    }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="container" id="movieContainer">
      <p style="margin-top:40vh;">Cargando pel√≠cula...</p>
    </div>
  </div>

  <script>
    const TMDB_KEY = "cc5b94165972aa509a349161d13d4fc9";
    const TMDB_BASE = "https://api.themoviedb.org/3";
    const TMDB_IMG = "https://image.tmdb.org/t/p/original";
    const VIDEO_FOLDER = "peliculas";
    const FORMATS = [".mkv", ".mp4", ".m3u8"];
    const JSON_PATH = "data/enlaces.json";

    const id = new URLSearchParams(window.location.search).get("id");

    if (!id) {
      document.getElementById("movieContainer").innerHTML =
        `<div class="not-found">No se proporcion√≥ ID de pel√≠cula.</div>`;
    } else {
      init();
    }

    async function init() {
      try {
        // Cargar informaci√≥n de TMDb
        const res = await fetch(`${TMDB_BASE}/movie/${id}?api_key=${TMDB_KEY}&language=es-MX`);
        const movie = await res.json();
        renderMovie(movie);
      } catch (e) {
        document.getElementById("movieContainer").innerHTML =
          `<div class="not-found">No se pudo cargar la informaci√≥n de la pel√≠cula.</div>`;
      }
    }

    function formatDate(d) {
      if (!d) return "Desconocida";
      const parts = d.split("-");
      return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }

    function renderMovie(movie) {
      if (movie.backdrop_path) {
        document.body.style.backgroundImage = `url(${TMDB_IMG + movie.backdrop_path})`;
      }

      const container = document.getElementById("movieContainer");
      container.innerHTML = `
        <img src="${TMDB_IMG + movie.poster_path}" class="poster">
        <h1>${movie.title}</h1>
        <div class="details">
          <span>üìÖ ${formatDate(movie.release_date)}</span>
          <span>‚è±Ô∏è ${movie.runtime || "?"} min</span>
          <span class="rating">‚≠ê ${(movie.vote_average * 10).toFixed(0)}%</span>
        </div>
        <div class="genres">
          ${(movie.genres || []).map(g => `<div class="genre">${g.name}</div>`).join("")}
        </div>
        <div class="overview">${movie.overview || "Sin descripci√≥n disponible."}</div>
        <div id="player"></div>
      `;
      loadVideo(id);
    }

    async function fileExists(url) {
      try {
        const r = await fetch(url, { method: "HEAD" });
        return r.ok;
      } catch {
        return false;
      }
    }

    async function loadVideo(id) {
      let found = null;

      // 1Ô∏è‚É£ Buscar en enlaces.json
      try {
        const res = await fetch(JSON_PATH);
        const data = await res.json();
        if (data[id]) found = data[id];
      } catch (e) {
        console.warn("No se pudo cargar enlaces.json", e);
      }

      // 2Ô∏è‚É£ Si no hay enlace manual, buscar en /peliculas/
      if (!found) {
        for (const ext of FORMATS) {
          const url = `${window.location.origin}/${VIDEO_FOLDER}/${id}${ext}`;
          if (await fileExists(url)) {
            found = url;
            break;
          }
        }
      }

      // 3Ô∏è‚É£ Mostrar o reproducir
      if (!found) {
        document.getElementById("player").innerHTML = `
          <div class="not-found">üé¨ Esta pel√≠cula a√∫n no est√° disponible.<br>
          Agrega un enlace en <code>${JSON_PATH}</code> o sube el archivo a <code>/${VIDEO_FOLDER}/${id}.mp4</code>.</div>`;
        return;
      }

      jwplayer("player").setup({
        file: found,
        width: "100%",
        aspectratio: "16:9",
        autostart: false,
        controls: true,
        playbackRateControls: true,
        skin: { name: "seven" },
      });
    }
  </script>
</body>
</html>
